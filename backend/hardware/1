import smbus
import time
import RPi.GPIO as GPIO
from threading import Thread, Lock
from queue import Queue
import buzzer, mpu6050, load_cell

class BottleHardware:
    def __init__(self):
        # Classes to use
        print("Initialising buzzer...")
        self.buzzer = buzzer.PiezoBuzzer()

        print("Initialising mpu6050...")
        self.mpu6050 = mpu6050.MPU6050()

        print("Initialising load cell...")
        self.load_cell = load_cell.LoadCell()

        # Threading
        self.running = False
        self.thread = None
        self.events_queue = Queue()
        self.lock = Lock()


    def _monitor_loop(self):
        try:
            while self.running:
                ax, ay, az = self.mpu6050.read_accel()
                pitch = self.mpu6050.tilt_angles(ax, ay, az)
                print(ax, ay, az)
                weight = self.load_cell.read_weight()
                now = time.time()
                events = [] # Events are appended here to send to PubNub 

                # Update previous readings
                self.mpu6050.update_readings(ax, ay, az, pitch)

                # Movement detection
                if self.mpu6050.detect_movement(ax, ay, az, now):
                    events.append("Bottle has been picked up!")


                # Bottle has been placed down detection
                if self.mpu6050.detect_bottle_placement(now):
                    prev_weight = self.load_cell.prev_weight
                    changed_weight = self.load_cell.detect_weight_change(weight)
                    water_drank = weight - prev_weight

                    if changed_weight is True:
                        events.append(f"{water_drank} ml of water was consumed")
                    elif changed_weight is False: 
                        events.append("No water was drunk!")


                # Drinking detection
                is_drinking = self.mpu6050.detect_drinking(pitch, now)
                if is_drinking is True:
                    events.append("Drinking has started")
                elif is_drinking is False:
                    events.append("Drinking has been stopped")


                # Inactivity alert
                if self.mpu6050.detect_inactivity(now):
                    events.append("Please drink your water!")
                    self.buzzer.trigger_buzzer()


                # Add events to queue
                for e in events:
                    with self.lock:
                        self.events_queue.put(e)


                time.sleep(0.1)

        except KeyboardInterrupt:
            pass
        finally:
            self.cleanup()

    # Set up
    def start(self):
        if not self.running:
            self.running = True
            self.thread = Thread(target=self._monitor_loop, daemon=True)
            self.thread.start()


    # Tear down
    def stop(self):
        self.running = False
        if self.thread:
            self.thread.join()  # wait for the monitoring thread to exit
        self.cleanup()

    def cleanup(self):
        self.buzzer.buzzer_pwm.stop()
        GPIO.cleanup()
        self.running = False
